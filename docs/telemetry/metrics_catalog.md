# Metrics Catalog

Complete reference of all Prometheus metrics exposed by Njord Quant.

## Table of Contents

- [Strategy Metrics](#strategy-metrics)
- [Portfolio Metrics](#portfolio-metrics)
- [Risk Metrics](#risk-metrics)
- [Order Execution Metrics](#order-execution-metrics)
- [System Health Metrics](#system-health-metrics)
- [Data Pipeline Metrics](#data-pipeline-metrics)

---

## Strategy Metrics

### `njord_strategy_pnl_usd`

**Type:** Gauge
**Labels:** `strategy_id`
**Description:** Current profit/loss for strategy in USD

**Example PromQL:**
```promql
# Total P&L across all strategies
sum(njord_strategy_pnl_usd)

# P&L for specific strategy
njord_strategy_pnl_usd{strategy_id="alpha"}

# Top 5 strategies by P&L
topk(5, njord_strategy_pnl_usd)
```

### `njord_strategy_sharpe_ratio`

**Type:** Gauge
**Labels:** `strategy_id`
**Description:** Sharpe ratio (risk-adjusted return) for strategy

**Example PromQL:**
```promql
# Strategies with Sharpe > 1.0
njord_strategy_sharpe_ratio > 1.0

# Average Sharpe across all strategies
avg(njord_strategy_sharpe_ratio)
```

### `njord_strategy_win_rate`

**Type:** Gauge
**Labels:** `strategy_id`
**Description:** Win rate (0.0-1.0) for strategy

**Example PromQL:**
```promql
# Strategies with win rate > 50%
njord_strategy_win_rate > 0.5
```

### `njord_strategy_drawdown_pct`

**Type:** Gauge
**Labels:** `strategy_id`
**Description:** Maximum drawdown percentage for strategy

**Example PromQL:**
```promql
# Strategies with drawdown > 10%
njord_strategy_drawdown_pct > 10.0

# Alert if any strategy drawdown exceeds 15%
max(njord_strategy_drawdown_pct) > 15.0
```

### `njord_signals_generated_total`

**Type:** Counter
**Labels:** `strategy_id`, `signal_type`
**Description:** Total number of signals generated by strategy

**Example PromQL:**
```promql
# Signals per minute
rate(njord_signals_generated_total[1m])

# Signals by type
sum by (signal_type) (njord_signals_generated_total)
```

### `njord_strategy_errors_total`

**Type:** Counter
**Labels:** `strategy_id`, `error_type`
**Description:** Total errors encountered by strategy

**Example PromQL:**
```promql
# Error rate
rate(njord_strategy_errors_total[5m])

# Strategies with errors
count(njord_strategy_errors_total > 0) by (strategy_id)
```

---

## Portfolio Metrics

### `njord_portfolio_equity_usd`

**Type:** Gauge
**Labels:** `portfolio_id`
**Description:** Current portfolio equity in USD

**Example PromQL:**
```promql
# Current equity
njord_portfolio_equity_usd{portfolio_id="main"}

# 1-hour change
delta(njord_portfolio_equity_usd[1h])
```

### `njord_portfolio_daily_pnl_usd`

**Type:** Gauge
**Labels:** `portfolio_id`
**Description:** Daily profit/loss in USD

**Example PromQL:**
```promql
# Daily P&L
njord_portfolio_daily_pnl_usd

# Alert if daily loss > $5000
njord_portfolio_daily_pnl_usd < -5000
```

### `njord_position_count`

**Type:** Gauge
**Labels:** `portfolio_id`
**Description:** Number of active positions

**Example PromQL:**
```promql
# Active positions
njord_position_count

# Alert if positions exceed limit
njord_position_count > 50
```

---

## Risk Metrics

### `njord_risk_checks_total`

**Type:** Counter
**Labels:** `check_type`, `result`
**Description:** Total risk checks performed

**Example PromQL:**
```promql
# Risk check rate
rate(njord_risk_checks_total[1m])

# Rejection rate
rate(njord_risk_checks_total{result="rejected"}[5m]) /
rate(njord_risk_checks_total[5m])
```

### `njord_risk_limit_utilization`

**Type:** Gauge
**Labels:** `limit_type`
**Description:** Risk limit utilization (0.0-1.0)

**Example PromQL:**
```promql
# Limits near capacity
njord_risk_limit_utilization > 0.9

# Alert if any limit > 95%
max(njord_risk_limit_utilization) > 0.95
```

### `njord_killswitch_active`

**Type:** Gauge
**Description:** Kill-switch status (0=inactive, 1=active)

**Example PromQL:**
```promql
# Kill-switch status
njord_killswitch_active

# Alert on activation
njord_killswitch_active == 1
```

---

## Order Execution Metrics

### `njord_orders_placed_total`

**Type:** Counter
**Labels:** `strategy_id`, `symbol`, `side`
**Description:** Total orders placed

**Example PromQL:**
```promql
# Orders per minute
rate(njord_orders_placed_total[1m])

# Orders by symbol
sum by (symbol) (njord_orders_placed_total)

# Buy vs sell ratio
sum(njord_orders_placed_total{side="buy"}) /
sum(njord_orders_placed_total{side="sell"})
```

### `njord_fills_generated_total`

**Type:** Counter
**Labels:** `strategy_id`, `symbol`, `venue`
**Description:** Total fills generated

**Example PromQL:**
```promql
# Fill rate
rate(njord_fills_generated_total[1m])

# Fills by venue
sum by (venue) (njord_fills_generated_total)
```

### `njord_order_rejection_rate`

**Type:** Gauge
**Description:** Order rejection rate (0.0-1.0)

**Example PromQL:**
```promql
# Current rejection rate
njord_order_rejection_rate

# Alert if rejection rate > 10%
njord_order_rejection_rate > 0.1
```

### `njord_fill_latency_ms`

**Type:** Histogram
**Labels:** `venue`
**Description:** Fill latency in milliseconds

**Example PromQL:**
```promql
# Median latency
histogram_quantile(0.5, njord_fill_latency_ms_bucket)

# 95th percentile
histogram_quantile(0.95, njord_fill_latency_ms_bucket)

# Alert if p95 > 1 second
histogram_quantile(0.95, njord_fill_latency_ms_bucket) > 1000
```

### `njord_slippage_bps`

**Type:** Histogram
**Labels:** `symbol`, `side`
**Description:** Slippage in basis points

**Example PromQL:**
```promql
# Average slippage
avg(njord_slippage_bps)

# Slippage by symbol
avg by (symbol) (njord_slippage_bps)
```

---

## System Health Metrics

### `njord_event_loop_lag_seconds`

**Type:** Gauge
**Description:** Event loop lag in seconds

**Example PromQL:**
```promql
# Current lag
njord_event_loop_lag_seconds

# Alert if lag > 100ms
njord_event_loop_lag_seconds > 0.1
```

### `njord_memory_usage_mb`

**Type:** Gauge
**Description:** Memory usage in megabytes

**Example PromQL:**
```promql
# Current memory
njord_memory_usage_mb

# Alert if memory > 512MB
njord_memory_usage_mb > 512
```

### `njord_bus_messages_sent_total`

**Type:** Counter
**Labels:** `topic`
**Description:** Total messages sent on event bus

**Example PromQL:**
```promql
# Message rate
rate(njord_bus_messages_sent_total[1m])

# Messages by topic
sum by (topic) (njord_bus_messages_sent_total)
```

### `njord_bus_messages_received_total`

**Type:** Counter
**Labels:** `topic`
**Description:** Total messages received from event bus

**Example PromQL:**
```promql
# Receive rate
rate(njord_bus_messages_received_total[1m])

# Topic throughput
rate(njord_bus_messages_received_total[1m]) by (topic)
```

### `njord_journal_writes_total`

**Type:** Counter
**Labels:** `journal_type`
**Description:** Total journal writes

**Example PromQL:**
```promql
# Write rate
rate(njord_journal_writes_total[1m])

# Writes by type
sum by (journal_type) (njord_journal_writes_total)
```

### `njord_journal_bytes_total`

**Type:** Counter
**Labels:** `journal_type`
**Description:** Total bytes written to journals

**Example PromQL:**
```promql
# Write throughput (MB/s)
rate(njord_journal_bytes_total[1m]) / 1024 / 1024

# Alert if write rate > 10 MB/s
rate(njord_journal_bytes_total[1m]) > 10485760
```

---

## Data Pipeline Metrics

### `njord_market_data_updates_total`

**Type:** Counter
**Labels:** `symbol`, `data_type`
**Description:** Total market data updates received

**Example PromQL:**
```promql
# Update rate
rate(njord_market_data_updates_total[1m])

# Updates by symbol
sum by (symbol) (njord_market_data_updates_total)
```

### `njord_parquet_writes_total`

**Type:** Counter
**Labels:** `data_type`
**Description:** Total parquet file writes

**Example PromQL:**
```promql
# Parquet write rate
rate(njord_parquet_writes_total[1m])
```

---

## Alert Rule Examples

### Critical Alerts

```yaml
groups:
  - name: critical_alerts
    interval: 30s
    rules:
      - alert: HighDrawdown
        expr: njord_strategy_drawdown_pct > 15.0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Strategy {{ $labels.strategy_id }} drawdown > 15%"
          description: "Current drawdown: {{ $value }}%"

      - alert: DailyLossLimitExceeded
        expr: njord_portfolio_daily_pnl_usd < -5000
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "Daily loss limit exceeded"
          description: "Current P&L: ${{ $value }}"

      - alert: KillSwitchActivated
        expr: njord_killswitch_active == 1
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "Kill-switch activated - trading halted"
```

### Warning Alerts

```yaml
  - name: warning_alerts
    interval: 1m
    rules:
      - alert: HighEventLoopLag
        expr: njord_event_loop_lag_seconds > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Event loop lag > 100ms"
          description: "Current lag: {{ $value }}s"

      - alert: HighMemoryUsage
        expr: njord_memory_usage_mb > 512
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Memory usage > 512MB"

      - alert: HighOrderRejectionRate
        expr: njord_order_rejection_rate > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Order rejection rate > 10%"
```

---

## Metric Naming Conventions

All metrics follow Prometheus naming conventions:

- **Prefix:** `njord_` for all application metrics
- **Units:** Include unit suffix (e.g., `_seconds`, `_bytes`, `_total`)
- **Counters:** End with `_total` suffix
- **Labels:** Use snake_case, avoid high-cardinality values
- **Help Text:** Descriptive, includes units

---

## Cardinality Management

**Warning Threshold:** 100 unique label combinations per metric

**High-Cardinality Labels to Avoid:**
- User IDs
- Trade IDs
- Timestamps
- Unique order IDs

**Safe Labels:**
- Strategy ID (bounded set)
- Symbol (bounded set)
- Venue (bounded set)
- Result types (success/failure)

---

## Retention Policy

| Resolution | Retention Period |
|------------|------------------|
| 1 minute   | 7 days          |
| 5 minutes  | 30 days         |
| 1 hour     | 180 days        |
| 1 day      | 730 days (2 years) |

---

**Last Updated:** 2025-10-07
**Maintainer:** Njord Trust
**Related:** [Grafana Setup](./grafana_setup.md) | [Operations Runbook](./operations_runbook.md)
